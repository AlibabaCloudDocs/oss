# Authorized access

OSS SDK for Android provides two authentication modes to ensure the data security of mobile devices: STS authentication mode and self-signed mode.

## Background information

When you use either the STS authentication mode or self-signed mode, ensure that the callback function that you implement returns results. If you must obtain the token and signature from the app server by sending a request in the callback function, we recommend that you call the synchronous API operations included in the network library. The callback function is run in the child thread of the request generated by the SDK and does not block the main thread.

## STS authentication mode

**Note:** To use the STS authentication mode, you must first activate Alibaba Cloud RAM.

You can use Alibaba Cloud Security Token Service \(STS\) to authorize temporary access to OSS. STS is a web service that provides temporary access tokens for cloud computing users. You can use STS to grant a third-party application or your RAM user an access credential with a customized validity period and permissions. For more information about STS, see [What is STS?](/intl.en-US/API Reference/API Reference (STS)/What is STS?.md)

STS has the following benefits:

-   You need only to generate an access token and send the access token to a third-party application, instead of exposing your long-term AccessKey pair to the third-party application. You can customize the access permissions and validity period of this token.
-   The access token automatically expires when the validity period ends.

For more information about how to access OSS by using STS, see [Access OSS with a temporary access credential provided by STS](/intl.en-US/Developer Guide/Data security/Access and control/Access OSS with a temporary access credential provided by STS.md) in OSS Developer Guide.

-   Configure STSToken

    You can obtain an STSToken in the app by a certain method, such as sending a request to the app server, and use the STSToken to initialize the SDK. If you use this method, you must pay attention to the expiration time of the STSToken. When the STSToken is about to expire, you must update the new STSToken for the SDK.

    The following code provides an example on how to use an obtained STSToken to initialize the SDK:

    ```
    String endpoint = "http://oss-cn-hangzhou.aliyuncs.com";
    
    OSSCredentialProvider credentialProvider = new OSSStsTokenCredentialProvider("<StsToken.AccessKeyId>", "<StsToken.SecretKeyId>", "<StsToken.SecurityToken>");
    
    OSS oss = new OSSClient(getApplicationContext(), endpoint, credentialProvider);
                        
    ```

    When the STSToken is about to expire, you can create a new OSSClient or update OSSStsTokenCredentialProvider by using the following method:

    ```
    oss.updateCredentialProvider(new OSSStsTokenCredentialProvider("<StsToken.AccessKeyId>", "<StsToken.SecretKeyId>", "<StsToken.SecurityToken>"));
                        
    ```

-   Obtain the STSToken by implementing callback

    If you want the SDK to automatically update the STSToken, you must implement callback in your app. The app uses the callback to obtain a FederationToken \(STSToken\) and returns it to the SDK. The SDK uses the STSToken for signing. When the STSToken needs to be updated, the SDK calls the callback to obtain a new token.

    ```
    String endpoint = "http://oss-cn-hangzhou.aliyuncs.com";
    
    OSSCredentialProvider credentialProvider = new OSSFederationCredentialProvider() {
    
        @Override
        public OSSFederationToken getFederationToken() {
        // Implement a method to obtain a FederationToken and return it as an OSSFederationToken object. If the FederationToken is not obtained, null is returned.
    
            OSSFederationToken * token;
            // Obtain a FederationToken from your server.
            ...
            return token;
        }
    };
    
    OSS oss = new OSSClient(getApplicationContext(), endpoint, credentialProvider);
                        
    ```

    **Note:** Additionally, if you have obtained all fields required to generate a token in other methods, you can also return these fields by using the callback. In this case, you must manually update the token, and then reconfigure OSSCredentialProvider of the OSSClient instance.

    If the URL of the server from which you request a token is http://localhost:8080/distribute-token.json, the following data is returned:

    ```
    {
        "StatusCode": 200,
        "AccessKeyId":"STS.iA645eTOXEqP3cg3****",
        "AccessKeySecret":"rV3VQrpFQ4BsyHSAvi5NVLpPIVffDJv4LojU****",
        "Expiration":"2015-11-03T09:52:59Z",
        "SecurityToken":"CAES7QIIARKAAZPlqaN9ILiQZPS+JDkS/GSZN45RLx4YS/p3OgaUC+oJl3XSlbJ7StKpQ****"}
                        
    ```

    The following code provides an example on how to implement `OSSFederationCredentialProvider`:

    ```
    OSSCredentialProvider credetialProvider = new OSSFederationCredentialProvider() {
        @Override
        public OSSFederationToken getFederationToken() {
            try {
                URL stsUrl = new URL("http://localhost:8080/distribute-token.json");
                HttpURLConnection conn = (HttpURLConnection) stsUrl.openConnection();
                InputStream input = conn.getInputStream();
                String jsonText = IOUtils.readStreamAsString(input, OSSConstants.DEFAULT_CHARSET_NAME);
                JSONObject jsonObjs = new JSONObject(jsonText);
                String ak = jsonObjs.getString("AccessKeyId");
                String sk = jsonObjs.getString("AccessKeySecret");
                String token = jsonObjs.getString("SecurityToken");
                String expiration = jsonObjs.getString("Expiration");
                return new OSSFederationToken(ak, sk, token, expiration);
            } catch (Exception e) {
                e.printStackTrace();
            }
            return null;
        }
    };
                        
    ```


## Self-signed mode

You can save the AccessKey ID and AccessKey secret on your own server, and then sign the client information by using your own server. Perform the following operations:

1.  Obtain and send the string to be signed on the client to your own server.
    1.  Use the signContent method of OSSCustomSignerCredentialProvider in the SDK to obtain the string to be signed when you construct the request.
    2.  Send the string to be signed to your own server.
2.  Sign the signature on your own server and return the string to the client.
    1.  Sign the string based on the signature algorithm specified by OSS. For more information about the signature algorithm, see [Add signatures to headers](/intl.en-US/API Reference/Access control/Add signatures to headers.md).

        The format of the signature algorithm is `signature = "OSS " + AccessKeyId + ":" + base64(hmac-sha1(AccessKeySecret, content))`, where content is the string that is concatenated based on the request parameters. The following code provides an example on how to sign the string based on the signature algorithm.

        ```
        String endpoint = "http://oss-cn-hangzhou.aliyuncs.com";
        
        credentialProvider = new OSSCustomSignerCredentialProvider() {
            @Override
            public String signContent(String content) {
            // Sign a string by using the signature algorithm specified by OSS, concatenate your AccessKey ID to the signature string, and return the result.
            // Post the string to your app server and return the signature. // If the signing fails, return null with the error message.
        
                return "OSS " + AccessKeyId + ":" + base64(hmac-sha1(AccessKeySecret, content));
            }
        };
        
        OSS oss = new OSSClient(getApplicationContext(), endpoint, credentialProvider);
                    
        ```

    2.  The signed string is returned to the client.
3.  Send the signed string on the client to the OSS server for authentication.

